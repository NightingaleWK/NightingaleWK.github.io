{
    "version": "https://jsonfeed.org/version/1",
    "title": "雪漫城的风宅 • All posts by \"定时任务\" tag",
    "description": "この世界は好都合に未完成 だから知りたいんだ —— チ。-地球の運動について-",
    "home_page_url": "https://nightingalewk.cn",
    "items": [
        {
            "id": "https://nightingalewk.cn/2022/04/14/40.%20Laravel%20%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F/",
            "url": "https://nightingalewk.cn/2022/04/14/40.%20Laravel%20%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F/",
            "title": "laravel 定时任务配置方式",
            "date_published": "2022-04-14T05:39:00.000Z",
            "content_html": "<h2 id=\"1-创建一个自定义的-Command\"><a href=\"#1-创建一个自定义的-Command\" class=\"headerlink\" title=\"1. 创建一个自定义的 Command\"></a>1. 创建一个自定义的 Command</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php artisan make:command WarrantyRefresh</span><br></pre></td></tr></table></figure>\n<span id=\"more\"></span>\n\n<h2 id=\"2-编辑-WarrantyRefresh-php-文件（app-Console-Commands-WarrantyRefresh-php）\"><a href=\"#2-编辑-WarrantyRefresh-php-文件（app-Console-Commands-WarrantyRefresh-php）\" class=\"headerlink\" title=\"2. 编辑 WarrantyRefresh.php 文件（app&#x2F;Console&#x2F;Commands&#x2F;WarrantyRefresh.php）\"></a>2. 编辑 WarrantyRefresh.php 文件（app&#x2F;Console&#x2F;Commands&#x2F;WarrantyRefresh.php）</h2><p>​</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">namespace App\\Console\\Commands;</span><br><span class=\"line\"></span><br><span class=\"line\">use App\\Admin\\Controllers\\Api\\StaticFun;</span><br><span class=\"line\">use App\\Models\\Asset;</span><br><span class=\"line\">use Illuminate\\Console\\Command;</span><br><span class=\"line\">use Illuminate\\Support\\Facades\\Log;</span><br><span class=\"line\"></span><br><span class=\"line\">class WarrantyRefresh extends Command</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    /**</span><br><span class=\"line\">     * The name and signature of the console command.</span><br><span class=\"line\">     *</span><br><span class=\"line\">     * @var string</span><br><span class=\"line\">     */</span><br><span class=\"line\">    protected $signature = &#x27;command:warrantyRefresh&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">    /**</span><br><span class=\"line\">     * The console command description.</span><br><span class=\"line\">     *</span><br><span class=\"line\">     * @var string</span><br><span class=\"line\">     */</span><br><span class=\"line\">    protected $description = &#x27;刷新资产质保时间为最新状态&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">    /**</span><br><span class=\"line\">     * Create a new command instance.</span><br><span class=\"line\">     *</span><br><span class=\"line\">     * @return void</span><br><span class=\"line\">     */</span><br><span class=\"line\">    public function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        parent::__construct();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    /**</span><br><span class=\"line\">     * Execute the console command.</span><br><span class=\"line\">     *</span><br><span class=\"line\">     * @return int</span><br><span class=\"line\">     */</span><br><span class=\"line\">    public function handle()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $this-&gt;info(now() . &quot; Start Refresh Asset Warranty Remain&quot;);</span><br><span class=\"line\">        // 拿到全部资产信息</span><br><span class=\"line\">        $assets = Asset::all();</span><br><span class=\"line\"></span><br><span class=\"line\">        // 创建进度条</span><br><span class=\"line\">        $bar = $this-&gt;output-&gt;createProgressBar(count($assets));</span><br><span class=\"line\"></span><br><span class=\"line\">        // 开始循环计算资产剩余质保时间并更新</span><br><span class=\"line\">        foreach ($assets as $key =&gt; $value) &#123;</span><br><span class=\"line\">            // 计算</span><br><span class=\"line\">            $warranty_info = StaticFun::get2DateInfo($value-&gt;warranty_start, $value-&gt;warranty_end);</span><br><span class=\"line\">            // 拿取</span><br><span class=\"line\">            $warranty_remain = $warranty_info[&#x27;warranty_remain&#x27;];</span><br><span class=\"line\">            // 更新写入</span><br><span class=\"line\">            $asset = Asset::find($value-&gt;id);</span><br><span class=\"line\">            $asset-&gt;warranty_remain = $warranty_remain;</span><br><span class=\"line\">            $asset-&gt;save();</span><br><span class=\"line\"></span><br><span class=\"line\">            // 进度条+1</span><br><span class=\"line\">            $bar-&gt;advance();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // 进度条结束</span><br><span class=\"line\">        $bar-&gt;finish();</span><br><span class=\"line\">        </span><br><span class=\"line\">        $this-&gt;info(&quot;\\n&quot; . now() . &quot; Finish Refresh √ \\n&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"3-修改kernel-php\"><a href=\"#3-修改kernel-php\" class=\"headerlink\" title=\"3.修改kernel.php\"></a>3.修改kernel.php</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">namespace App\\Console;</span><br><span class=\"line\"></span><br><span class=\"line\">use Illuminate\\Console\\Scheduling\\Schedule;</span><br><span class=\"line\">use Illuminate\\Foundation\\Console\\Kernel as ConsoleKernel;</span><br><span class=\"line\"></span><br><span class=\"line\">class Kernel extends ConsoleKernel</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    /**</span><br><span class=\"line\">     * Define the application&#x27;s command schedule.</span><br><span class=\"line\">     *</span><br><span class=\"line\">     * @param  \\Illuminate\\Console\\Scheduling\\Schedule  $schedule</span><br><span class=\"line\">     * @return void</span><br><span class=\"line\">     */</span><br><span class=\"line\">    protected function schedule(Schedule $schedule)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        // 每天0点刷新资产剩余质保日期</span><br><span class=\"line\">        $schedule-&gt;command(&#x27;command:warrantyRefresh&#x27;)-&gt;daily();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    /**</span><br><span class=\"line\">     * Register the commands for the application.</span><br><span class=\"line\">     *</span><br><span class=\"line\">     * @return void</span><br><span class=\"line\">     */</span><br><span class=\"line\">    protected function commands()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $this-&gt;load(__DIR__ . &#x27;/Commands&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">        require base_path(&#x27;routes/console.php&#x27;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"4-执行定时任务\"><a href=\"#4-执行定时任务\" class=\"headerlink\" title=\"4.执行定时任务\"></a>4.执行定时任务</h2><p>手动执行：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php artisan command:WarrantyRefresh</span><br></pre></td></tr></table></figure>\n<p>服务器自动执行：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.编辑定时任务：</span><br><span class=\"line\">crontab -e</span><br><span class=\"line\"></span><br><span class=\"line\">2.php多版本可以将php改为版本的绝对路径，项目路径</span><br><span class=\"line\"> * * * * * php /www/wwwroot/yanji/artisan schedule:run &gt;&gt; /www/wwwroot/yanji/CronReord.txt 2&gt;&amp;1</span><br><span class=\"line\"></span><br><span class=\"line\">3.CentOS 7 重启 cron 服务</span><br><span class=\"line\">systemctl restart crond.service </span><br></pre></td></tr></table></figure>",
            "tags": [
                "定时任务"
            ]
        }
    ]
}